FROM python:3.11-slim AS builder
ENV PIP_NO_CACHE_DIR=1 PIP_DISABLE_PIP_VERSION_CHECK=1 PIP_ROOT_USER_ACTION=ignore
COPY base-requirements.txt .
RUN python -m pip install -r base-requirements.txt

ARG REPO_BRANCH=main
ADD [ "https://github.com/LeightonSmallshire/iter8-bot.git#${REPO_BRANCH}", "/app/" ]
RUN pip install -r /app/requirements.txt

FROM gcr.io/distroless/python3-debian12:debug-nonroot AS runner
ENV PYTHONUNBUFFERED=1 PYTHONIOENCODING=UTF-8 PYTHONDONTWRITEBYTECODE=1
ENV PYTHONPATH="/usr/local/lib/python3.11/site-packages"
COPY --chown=nonroot:nonroot --from=builder /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/
COPY --chown=nonroot:nonroot --from=builder /app/ /app/

WORKDIR /app
ENTRYPOINT ["python3", "/app/entrypoint.py"]
